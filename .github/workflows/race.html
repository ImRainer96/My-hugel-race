<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RO Hugel Manager (Final v1.2)</title>
    <style>
        :root {
            --bg-body: #0b1120;
            --bg-panel: #1e293b;
            --primary: #3b82f6;
            --gold: #f59e0b;
            --green: #10b981;
            --red: #ef4444;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        /* INPUTS */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        label { display: block; color: var(--text-muted); font-size: 0.75rem; margin-bottom: 3px; }
        input { width: 100%; background: #0f172a; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; font-weight: bold; }
        
        /* MONSTER CARDS */
        .monster-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .card {
            background: #334155; border: 2px solid transparent; border-radius: 8px;
            padding: 15px; text-align: center; cursor: pointer; position: relative; transition: 0.2s;
        }
        .card:hover { background: #475569; }
        .card.selected { background: rgba(59, 130, 246, 0.2); border-color: var(--primary); color: white; box-shadow: 0 0 10px rgba(59, 130, 246, 0.4); }
        .card.winner-1 { border-color: var(--gold); }
        .card.winner-2 { border-color: #cbd5e1; }
        .m-icon { font-size: 1.8rem; display: block; }

        /* ORACLE BOX */
        .oracle-box {
            background: linear-gradient(135deg, #4c1d95 0%, #be185d 100%);
            padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-oracle {
            background: white; color: #be185d; border: none; padding: 10px 20px;
            border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 1rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        .btn-oracle:active { transform: scale(0.95); }
        .oracle-result { margin-top: 10px; font-size: 0.9rem; line-height: 1.4; display: none; }
        .btn-apply-tip {
            margin-top: 8px; background: rgba(255,255,255,0.2); border: 1px solid white;
            color: white; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;
        }
        .btn-apply-tip:hover { background: rgba(255,255,255,0.4); }

        /* ANALYSIS */
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.8rem; }
        .algo-card { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; }

        /* CONTROLS */
        .mode-btn { background: #0f172a; padding: 8px; text-align: center; cursor: pointer; border-radius: 6px; color: var(--text-muted); }
        .mode-btn.active { background: var(--primary); color: white; }
        .action-btn { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; background: var(--green); color: white; }
        
        /* STATS */
        .stat-val { font-size: 1.5rem; font-weight: 800; }
        .text-gold { color: var(--gold); }

        @media (max-width: 900px) { .dashboard { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="dashboard">

    <div>
        <div class="panel settings-grid">
            <div><label>Character Count</label><input type="number" id="charCount" value="12" style="color:var(--gold);"></div>
            <div><label>Ticket Cost (Zeny)</label><input type="number" id="ticketCost" value="2000"></div>
            <div><label>Medals per Win</label><input type="number" id="medalReward" value="15"></div>
            
            <div><label style="color:var(--primary);">Target Prize Cost (Medals)</label><input type="number" id="prizeCost" value="50"></div>
        </div>

        <div class="panel">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div class="mode-btn active" id="mode-single" onclick="setMode('single')" style="flex:1">üèÜ Single</div>
                <div class="mode-btn" id="mode-double" onclick="setMode('double')" style="flex:1">üë• Double</div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="bet-title">1. Place Bet</h3>
                <button onclick="clearBet()" style="background:none; border:none; color:#94a3b8; cursor:pointer;">Clear</button>
            </div>
            <div class="monster-grid" id="bet-grid"></div>

            <div id="result-area" style="margin-top:20px; opacity:0.5; pointer-events:none;">
                <h3 style="margin-bottom:5px;">2. Race Result</h3>
                <small style="color:#94a3b8;">Select 1st Place (Gold) and 2nd Place (Silver)</small>
                <div class="monster-grid" id="result-grid" style="margin-top:10px;"></div>
                <button class="action-btn" onclick="submitRound()">‚úÖ SUBMIT ROUND</button>
            </div>
        </div>
    </div>

    <div>
        
        <div class="panel" style="padding:0; border:none; background:transparent;">
            <div class="oracle-box">
                <button class="btn-oracle" onclick="askOracle()">üîÆ Ask Oracle</button>
                <div id="oracle-msg" class="oracle-result">
                    <div id="oracle-text" style="margin-bottom:5px; font-weight:bold;">Calculating...</div>
                    <div id="oracle-reason" style="font-size:0.8rem; opacity:0.9;"></div>
                    <button class="btn-apply-tip" onclick="applyOracleTip()">Pick This ‚úîÔ∏è</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <h4 style="margin-top:0; color:var(--text-muted);">Farming Status</h4>
            
            <div style="text-align:center; margin-bottom:15px; background:rgba(59, 130, 246, 0.1); padding:10px; border-radius:8px; border:1px solid var(--primary);">
                <span style="font-size:0.8rem; color:var(--primary);">TOTAL PRIZES COLLECTED</span><br>
                <span class="stat-val" id="val-prizes" style="color:var(--text-main);">0</span>
                <span style="font-size:0.9rem; color:var(--text-muted);">Items</span>
            </div>

            <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                <span>Medals: <b id="val-medals" style="color:var(--gold);">0</b></span>
                <span>Spent: <b id="val-spent" style="color:#ef4444;">0 z</b></span>
            </div>
            
            <div style="text-align:center; margin-top:10px; padding-top:10px; border-top:1px solid #334155; font-size:0.85rem; color:#94a3b8;">
                Total Races: <b id="val-races" style="color:var(--text-main);">0</b> &nbsp;|&nbsp;
                Win Rate: <span id="val-winrate">0%</span>
            </div>
        </div>

        <div class="panel">
            <h4 style="margin-top:0; color:var(--text-muted);">Algorithm Analysis</h4>
            <div class="analysis-grid">
                <div class="algo-card">
                    <div style="font-weight:bold; margin-bottom:5px;">üßä Coldest</div>
                    <div id="list-cold">No Data</div>
                </div>
                <div class="algo-card">
                    <div style="font-weight:bold; margin-bottom:5px;">üî• Hottest</div>
                    <div id="list-hot">No Data</div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div style="display:flex; justify-content:space-between;">
                <h4>History</h4>
                <button onclick="undoLast()" style="background:none; border:1px solid #475569; color:white; border-radius:4px; cursor:pointer; font-size:0.8rem;">Undo</button>
            </div>
            <div id="history-list" style="max-height:200px; overflow-y:auto; font-size:0.85rem; margin-top:5px;"></div>
            <button onclick="hardReset()" style="width:100%; margin-top:10px; background:none; color:#ef4444; border:1px solid #ef4444; padding:5px; border-radius:4px; cursor:pointer;">Reset All Data</button>
        </div>

    </div>
</div>

<script>
    const monsters = [
        { id: 1, name: "Poring", icon: "üíß" },
        { id: 2, name: "Lunatic", icon: "üê∞" },
        { id: 3, name: "Savage", icon: "üêó" },
        { id: 4, name: "Wolf", icon: "üê∫" },
        { id: 5, name: "Devi", icon: "üëø" },
        { id: 6, name: "Bapho", icon: "üêê" }
    ];

    let state = {
        mode: 'single',
        bet: [],
        result: [],
        history: [],
        stats: { spent: 0, medals: 0, wins: 0 }
    };
    
    let currentTip = [];

    window.onload = () => {
        loadData();
        renderGrids();
        updateUI();
    };

    /* --- GAME CORE --- */
    function setMode(m) {
        state.mode = m;
        state.bet = [];
        state.result = [];
        document.getElementById('mode-single').className = m === 'single' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('mode-double').className = m === 'double' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('bet-title').innerText = m === 'single' ? '1. Place Bet (Pick 1)' : '1. Place Bet (Pick 2)';
        document.getElementById('oracle-msg').style.display = 'none';
        renderGrids();
        checkStep2();
    }

    function toggleBet(id) {
        const limit = state.mode === 'single' ? 1 : 2;
        if(state.bet.includes(id)) {
            state.bet = state.bet.filter(x => x!==id);
        } else {
            if(state.bet.length >= limit) {
                if(state.mode === 'single') state.bet.shift();
                else return;
            }
            state.bet.push(id);
        }
        renderGrids();
        checkStep2();
    }

    function toggleResult(id) {
        if(state.result.includes(id)) {
            state.result = state.result.filter(x => x!==id);
        } else {
            if(state.result.length >= 2) return;
            state.result.push(id);
        }
        renderGrids();
    }

    function renderGrids() {
        ['bet', 'result'].forEach(type => {
            const div = document.getElementById(type + '-grid');
            div.innerHTML = '';
            monsters.forEach(m => {
                const btn = document.createElement('div');
                let css = 'card';
                const arr = type === 'bet' ? state.bet : state.result;
                if(arr.includes(m.id)) {
                    css += ' selected';
                    if(type === 'result') css += (arr.indexOf(m.id)===0 ? ' winner-1' : ' winner-2');
                }
                btn.className = css;
                btn.innerHTML = `<span class="m-icon">${m.icon}</span><b>${m.name}</b>`;
                btn.onclick = () => type === 'bet' ? toggleBet(m.id) : toggleResult(m.id);
                div.appendChild(btn);
            });
        });
    }

    function checkStep2() {
        const target = state.mode === 'single' ? 1 : 2;
        const div = document.getElementById('result-area');
        if(state.bet.length === target) { div.style.opacity='1'; div.style.pointerEvents='auto'; }
        else { div.style.opacity='0.5'; div.style.pointerEvents='none'; }
    }

    function submitRound() {
        if(state.result.length === 0) { alert("Please enter the race result!"); return; }
        if(state.mode==='double' && state.result.length !== 2) { alert("For Double mode, you must select both 1st and 2nd place!"); return; }
        
        const count = parseInt(document.getElementById('charCount').value);
        const costPer = parseInt(document.getElementById('ticketCost').value);
        const rewardPer = parseInt(document.getElementById('medalReward').value);

        let isWin = false;
        if(state.mode === 'single') {
            if(state.bet[0] === state.result[0]) isWin = true;
        } else {
            const rSet = new Set(state.result);
            if(state.bet.every(b => rSet.has(b))) isWin = true;
        }

        const cost = count * costPer;
        const medals = isWin ? (count * rewardPer) : 0;

        state.stats.spent += cost;
        state.stats.medals += medals;
        if(isWin) state.stats.wins++;

        state.history.unshift({
            mode: state.mode, bet: [...state.bet], result: [...state.result],
            win: isWin, cost: cost, medals: medals, id: Date.now()
        });

        clearBet();
        state.result = [];
        document.getElementById('oracle-msg').style.display = 'none';
        
        renderGrids();
        checkStep2();
        saveData();
        updateUI();
    }

    /* --- ORACLE ALGORITHM --- */
    function askOracle() {
        if(state.history.length < 5) {
            alert("Oracle needs at least 5 rounds of history data!");
            return;
        }

        let scores = monsters.map(m => {
            let roundsSince = 0;
            for(let i=0; i<state.history.length; i++) {
                if(state.history[i].result.includes(m.id)) break;
                roundsSince++;
            }
            let recentWins = 0;
            const limit = 15;
            state.history.slice(0, limit).forEach(h => {
                if(h.result.includes(m.id)) recentWins++;
            });

            // Weighting
            let score = (roundsSince * 2) + (recentWins * 1.5) + (Math.random() * 3);
            return { id: m.id, name: m.name, score: score, cold: roundsSince, hot: recentWins };
        });

        scores.sort((a,b) => b.score - a.score);

        const pickCount = state.mode === 'single' ? 1 : 2;
        currentTip = scores.slice(0, pickCount).map(s => s.id);

        let mainText = scores.slice(0, pickCount).map(s => s.name).join(' & ');
        let reasonText = "";
        
        const best = scores[0];
        if (best.cold > 8) reasonText = `Because ${best.name} hasn't won in ${best.cold} rounds! (Overdue)`;
        else if (best.hot > 4) reasonText = `Because ${best.name} is on fire (Won ${best.hot} times recently).`;
        else reasonText = "Statistically the highest probability right now.";

        document.getElementById('oracle-msg').style.display = 'block';
        document.getElementById('oracle-text').innerText = mainText;
        document.getElementById('oracle-reason').innerText = reasonText;
    }

    function applyOracleTip() {
        if(currentTip.length > 0) {
            state.bet = [...currentTip];
            renderGrids();
            checkStep2();
        }
    }
    
    function clearBet() { state.bet = []; renderGrids(); checkStep2(); }

    /* --- ANALYTICS & UI --- */
    function updateUI() {
        // Prize Calc
        const prizeCost = parseInt(document.getElementById('prizeCost').value) || 1;
        const totalPrizes = (state.stats.medals / prizeCost).toFixed(1);
        
        document.getElementById('val-prizes').innerText = totalPrizes + "x";
        document.getElementById('val-medals').innerText = state.stats.medals.toLocaleString();
        document.getElementById('val-spent').innerText = "-" + state.stats.spent.toLocaleString() + " z";
        document.getElementById('val-races').innerText = state.history.length;
        
        const rate = state.history.length > 0 ? Math.round((state.stats.wins/state.history.length)*100) : 0;
        document.getElementById('val-winrate').innerText = rate + "%";

        updateAnalysisPanels();

        const hList = document.getElementById('history-list');
        hList.innerHTML = state.history.map(h => {
            const betN = h.bet.map(id=>monsters[id-1].name).join('-');
            const resN = h.result.map(id=>monsters[id-1].name).join('-');
            return `
                <div style="padding:8px; border-bottom:1px solid #334155; display:flex; justify-content:space-between; ${h.win ? 'background:rgba(16,185,129,0.1)' : ''}">
                    <span>${betN} vs ${resN}</span>
                    <span style="color:${h.win ? '#10b981':'#ef4444'}">${h.win ? '+' + h.medals + ' Medals' : '-' + h.cost + ' z'}</span>
                </div>
            `;
        }).join('');
    }

    function updateAnalysisPanels() {
        let coldHTML = "";
        let hotHTML = "";

        // Cold Calculation
        monsters.forEach(m => {
            let roundsSince = 0;
            for(let i=0; i<state.history.length; i++) {
                if(state.history[i].result.includes(m.id)) break;
                roundsSince++;
            }
            if(roundsSince >= 6) {
                coldHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:2px; ${roundsSince>=10 ? 'color:#fca5a5' : 'color:#cbd5e1'}">
                    <span>${m.name}</span><b>${roundsSince} turns</b></div>`;
            }
        });

        // Hot Calculation
        const limit = 15;
        let hotCounts = {};
        state.history.slice(0, limit).forEach(h => h.result.forEach(id => hotCounts[id] = (hotCounts[id]||0)+1));
        
        Object.entries(hotCounts)
            .sort(([,a],[,b]) => b-a)
            .slice(0,3)
            .forEach(([id, count]) => {
                const name = monsters[id-1].name;
                hotHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:2px;">
                    <span>${name}</span><b style="color:#fbbf24">${count} wins</b></div>`;
            });

        document.getElementById('list-cold').innerHTML = coldHTML || "<small style='color:#64748b'>No critical data</small>";
        document.getElementById('list-hot').innerHTML = hotHTML || "<small style='color:#64748b'>Not enough data</small>";
    }

    function undoLast() {
        if(state.history.length===0) return;
        state.history.shift();
        recalcStats(); saveData(); updateUI();
    }
    
    function recalcStats() {
        const totalMedals = state.history.reduce((sum, h) => sum + h.medals, 0);
        const totalSpent = state.history.reduce((sum, h) => sum + h.cost, 0);
        let wins = 0;
        state.history.forEach(h => { if(h.win) wins++; });

        state.stats.spent = totalSpent; 
        state.stats.medals = totalMedals;
        state.stats.wins = wins;
    }

    function hardReset() { if(confirm("Are you sure? This will delete all history.")) { localStorage.removeItem('ro_hugel_final_v12'); location.reload(); } }
    function saveData() { 
        const inputs = {
            charCount: document.getElementById('charCount').value,
            ticketCost: document.getElementById('ticketCost').value,
            medalReward: document.getElementById('medalReward').value,
            prizeCost: document.getElementById('prizeCost').value
        };
        localStorage.setItem('ro_hugel_inputs_v12', JSON.stringify(inputs));
        localStorage.setItem('ro_hugel_data_v12', JSON.stringify(state)); 
    }
    function loadData() { 
        const inputs = JSON.parse(localStorage.getItem('ro_hugel_inputs_v12'));
        if(inputs) {
            document.getElementById('charCount').value = inputs.charCount;
            document.getElementById('ticketCost').value = inputs.ticketCost;
            document.getElementById('medalReward').value = inputs.medalReward;
            document.getElementById('prizeCost').value = inputs.prizeCost;
        }
        const d = JSON.parse(localStorage.getItem('ro_hugel_data_v12')); 
        if(d) state = d; 
    }
</script>

</body>
</html>
